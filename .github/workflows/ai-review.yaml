name: AI Repository Assistant

on:
  pull_request:
    types: [opened]
  issues:
    types: [opened]
  issue_comment:
    types: [created] # æ”¯æŒé€šè¿‡è¯„è®ºè§¦å‘

jobs:
  ai-assistant:
    # ä»…åœ¨ï¼š1. æ–°å¼€ PR/Issue 2. è¯„è®ºä»¥ [use-ai] å¼€å¤´æ—¶è¿è¡Œ
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'issues' || 
      startsWith(github.event.comment.body, '[use-ai]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Context
        id: prep
        run: |
          # åˆ¤æ–­æ˜¯ PR è¿˜æ˜¯ Issue
          if [ "${{ github.event.pull_request }}" != "" ]; then
            EVENT_TYPE="PR"
            ISSUE_NUMBER="${{ github.event.pull_request.number }}"
            git fetch origin ${{ github.event.pull_request.base.ref }}
            git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > content.txt
          else
            EVENT_TYPE="Issue"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            # å¦‚æœæ˜¯è¯„è®ºè§¦å‘ï¼Œè·å–è¯„è®ºå†…å®¹ä½œä¸ºè¡¥å……æŒ‡ä»¤
            if [ "${{ github.event_name }}" == "issue_comment" ]; then
              echo "Command: ${{ github.event.comment.body }}" > content.txt
              echo -e "\nOriginal Content:\n${{ github.event.issue.title }}\n${{ github.event.issue.body }}" >> content.txt
            else
              echo -e "Title: ${{ github.event.issue.title }}\n\n${{ github.event.issue.body }}" > content.txt
            fi
          fi
          echo "type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      - name: AI Action Execution
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          MODEL: ${{ secrets.AI_MODEL }}
          EVENT_TYPE: ${{ steps.prep.outputs.type }}
          ISSUE_NUMBER: ${{ steps.prep.outputs.number }}
        with:
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('content.txt', 'utf8');

            // 1. è·å–ç°æœ‰ Labels
            const { data: repoLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const labelNames = repoLabels.map(l => l.name);

            // 2. è§’è‰²è®¾å®šï¼šä»â€œå»ºè®®è€…â€è½¬å˜ä¸ºâ€œæ‰§è¡Œè€…â€
            const prompt = `ä½ æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„ä»“åº“åŠ©æ‰‹ã€‚ä½ è¢«æˆæƒç®¡ç†è¯¥ä»“åº“çš„ Issues å’Œ PRã€‚
            ä½ çš„ä»»åŠ¡ï¼šåˆ†æå†…å®¹ï¼Œæ‰“ä¸Šæ ‡ç­¾ï¼Œå¹¶å†³å®šæ˜¯å¦å…³é—­æˆ–ä¿æŒå¼€å¯ã€‚
            
            ä»“åº“ç°æœ‰æ ‡ç­¾ï¼š[${labelNames.join(", ")}]ã€‚
            
            è¾“å‡ºè¦æ±‚ï¼š
            å¿…é¡»åœ¨å›å¤çš„ç¬¬ä¸€è¡Œè¾“å‡º JSON æ ¼å¼çš„æ“ä½œæŒ‡ä»¤ï¼š
            {"labels": ["label1"], "state": "closed" | "open"}
            
            éšåå¦èµ·ä¸€è¡Œï¼Œä»¥åŠ©æ‰‹çš„èº«ä»½ç®€æ´åœ°è¯´æ˜ä½ æ‰§è¡Œçš„æ“ä½œå’Œç†ç”±ã€‚ä¸è¦è¯´â€œæˆ‘å»ºè®®â€ï¼Œè¦è¯´â€œæˆ‘å·²æ‰§è¡Œâ€ã€‚
            
            å½“å‰ç¯å¢ƒï¼š${process.env.EVENT_TYPE}
            å†…å®¹è¯¦æƒ…ï¼š
            ${content}`;

            try {
              const response = await fetch(`${process.env.BASE_URL}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${process.env.API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  model: process.env.MODEL,
                  messages: [{ role: "user", content: prompt }],
                  temperature: 0.2
                })
              });

              const data = await response.json();
              const fullText = data.choices[0].message.content;

              // 3. è§£ææŒ‡ä»¤
              const jsonMatch = fullText.match(/^\{.*?\}/);
              let config = { labels: [], state: "open" };
              let commentBody = fullText;

              if (jsonMatch) {
                config = JSON.parse(jsonMatch[0]);
                commentBody = fullText.replace(jsonMatch[0], "").trim();
              }

              const issueParams = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(process.env.ISSUE_NUMBER)
              };

              // 4. æ‰§è¡Œæ“ä½œï¼šæ‰“æ ‡ç­¾
              if (config.labels && config.labels.length > 0) {
                await github.rest.issues.addLabels({ ...issueParams, labels: config.labels });
              }

              // 5. æ‰§è¡Œæ“ä½œï¼šä¿®æ”¹çŠ¶æ€ (Close/Reopen)
              if (config.state) {
                await github.rest.issues.update({ ...issueParams, state: config.state });
              }

              // 6. å‘å¸ƒæ‰§è¡ŒæŠ¥å‘Š
              await github.rest.issues.createComment({
                ...issueParams,
                body: `### ğŸ¤– AI Assistant Action\n\n${commentBody}`
              });

            } catch (err) {
              console.error(err);
              core.setFailed(err.message);
            }
