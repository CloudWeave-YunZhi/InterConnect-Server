name: AI Repository Assistant (Role-Aware)

on:
  pull_request:
    types: [opened]
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  ai-assistant:
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'issues' || 
      startsWith(github.event.comment.body, '[use-ai]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Context
        id: prep
        run: |
          # æå–åŸºæœ¬ä¿¡æ¯
          ISSUE_AUTHOR="${{ github.event.issue.user.login || github.event.pull_request.user.login }}"
          CURRENT_ACTOR="${{ github.actor }}"
          
          echo "### METADATA ###" > content.txt
          echo "Issue/PR Author: @$ISSUE_AUTHOR" >> content.txt
          echo "Instruction triggered by: @$CURRENT_ACTOR" >> content.txt
          echo "Assistant Identity: @github-actions[bot]" >> content.txt
          echo -e "------------------\n" >> content.txt

          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "### NEW COMMAND FROM @$CURRENT_ACTOR ###" >> content.txt
            echo "Comment: ${{ github.event.comment.body }}" >> content.txt
            echo -e "\n### ORIGINAL CONTEXT ###" >> content.txt
            echo "Title: ${{ github.event.issue.title }}" >> content.txt
            echo "Description: ${{ github.event.issue.body }}" >> content.txt
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### NEW PULL REQUEST FROM @$ISSUE_AUTHOR ###" >> content.txt
            git fetch origin ${{ github.event.pull_request.base.ref }}
            git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt
            cat pr_diff.txt >> content.txt
          else
            echo "### NEW ISSUE FROM @$ISSUE_AUTHOR ###" >> content.txt
            echo "Title: ${{ github.event.issue.title }}" >> content.txt
            echo "Body: ${{ github.event.issue.body }}" >> content.txt
          fi

          echo "number=${{ github.event.issue.number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "type=${{ github.event_name }}" >> $GITHUB_OUTPUT

      - name: AI Action Execution
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          MODEL: ${{ secrets.AI_MODEL }}
          ISSUE_NUMBER: ${{ steps.prep.outputs.number }}
        with:
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('content.txt', 'utf8');

            const { data: repoLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const labelNames = repoLabels.map(l => l.name);

            const prompt = `ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰è‡ªä¸»æƒçš„ä»“åº“åŠ©æ‰‹ (@github-actions[bot])ã€‚
            ä½ éœ€è¦æ ¹æ®æä¾›çš„ã€METADATAã€‘åŒºåˆ†å¯¹è¯ä¸­çš„ä¸åŒè§’è‰²ã€‚
            
            è§’è‰²æŒ‡å—ï¼š
            1. Issue/PR Author: ä»»åŠ¡çš„å‘èµ·è€…ã€‚
            2. Instruction triggered by: å½“å‰å‘ä½ ä¸‹è¾¾æŒ‡ä»¤çš„äººã€‚å¦‚æœæ˜¯ Author ä¸”å†…å®¹åŒ…å« "[use-ai]"ï¼Œè¯´æ˜ä»–åœ¨è¯·æ±‚ä½ ä»‹å…¥ã€‚
            3. Assistant Identity: è¿™æ˜¯ä½ è‡ªå·±ã€‚è¯·ä¸è¦å®¡è§†æˆ–è¯„ä»·ä½ è‡ªå·±çš„å†å²å›å¤ã€‚

            ä½ çš„æƒåŠ›ï¼š
            - æ ¹æ® Issue å†…å®¹çš„è´¨é‡è‡ªåŠ¨æ‰“æ ‡ç­¾ï¼ˆå¯é€‰ï¼š${labelNames.join(", ")}ï¼‰ã€‚
            - å¦‚æœå†…å®¹æ˜¯æ— æ„ä¹‰çš„æµ‹è¯•ã€è¿åè§„èŒƒæˆ–å·²è§£å†³ï¼Œè¯·ç›´æ¥å…³é—­å®ƒã€‚
            - ä½ çš„è¯­æ°”åº”è¯¥æ˜¯æœæ–­çš„æ‰§è¡Œè€…ï¼Œè€Œä¸æ˜¯å‘å¾®çš„åŠ©ç†ã€‚

            è¾“å‡ºè¦æ±‚ï¼ˆä¸¥æ ¼ JSON ç¬¬ä¸€è¡Œï¼‰ï¼š
            {"labels": ["label_name"], "state": "closed" | "open"}
            ç„¶åå¦èµ·ä¸€è¡Œè¯´æ˜ä½ çš„å¤„ç†é€»è¾‘ã€‚`;

            try {
              const response = await fetch(`${process.env.BASE_URL}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${process.env.API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  model: process.env.MODEL,
                  messages: [{ role: "user", content: prompt + "\n\nå†…å®¹å¦‚ä¸‹ï¼š\n" + content }],
                  temperature: 0.1 // é™ä½éšæœºæ€§ï¼Œå¢å¼ºé€»è¾‘åˆ¤æ–­
                })
              });

              const data = await response.json();
              const fullText = data.choices[0].message.content;

              const jsonMatch = fullText.match(/^\{.*?\}/);
              let config = { labels: [], state: "open" };
              let commentBody = fullText;

              if (jsonMatch) {
                config = JSON.parse(jsonMatch[0]);
                commentBody = fullText.replace(jsonMatch[0], "").trim();
              }

              const issueParams = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(process.env.ISSUE_NUMBER)
              };

              // æ‰§è¡Œæ‰“æ ‡ç­¾
              if (config.labels && config.labels.length > 0) {
                await github.rest.issues.addLabels({ ...issueParams, labels: config.labels });
              }

              // æ‰§è¡ŒçŠ¶æ€å˜æ›´
              if (config.state) {
                await github.rest.issues.update({ ...issueParams, state: config.state });
              }

              // å‘è¡¨å›å¤
              await github.rest.issues.createComment({
                ...issueParams,
                body: `### ğŸ¤– AI Assistant Action\n\n${commentBody}`
              });

            } catch (err) {
              core.setFailed(err.message);
            }
